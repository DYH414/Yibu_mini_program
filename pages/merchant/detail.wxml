<!-- 商家详情页 -->
<view class="container" wx:if="{{!loading && merchant}}">
  <!-- 商家基本信息 -->
  <view class="merchant-header card">
    <view class="merchant-basic-info">
      <view class="merchant-logo">
        <image src="{{merchant.logoUrl}}" mode="aspectFill"></image>
      </view>
      <view class="merchant-info">
        <view class="merchant-name">{{merchant.name}}</view>
        <view class="merchant-rating">
          <view class="rate">
            <block wx:for="{{5}}" wx:key="*this" wx:for-item="starIndex">
              <image 
                class="rate-star" 
                src="/images/stars/{{starIndex < Math.floor(merchant.avgRating) ? 'star-full.png' : (starIndex < Math.ceil(merchant.avgRating) ? 'star-half.png' : 'star-empty.png')}}">
              </image>
            </block>
            <text class="rating-text">{{merchant.avgRating}} ({{merchant.ratingCount}})</text>
          </view>
        </view>
        <view class="merchant-desc">{{merchant.description}}</view>
      </view>
      <view class="favorite-btn" bindtap="toggleFavorite">
        <image src="/images/icons/{{isFavorite ? 'favorite-filled.png' : 'favorite.png'}}"></image>
      </view>
    </view>
  </view>

  <!-- 平台跳转按钮 -->
  <view class="platform-section card">
    <view class="section-title">外卖平台</view>
    <view class="platform-tip">点击图标跳转到对应平台</view>
    <view class="platform-list">
      <view 
        class="platform-item" 
        wx:for="{{platforms}}" 
        wx:key="name"
        bindtap="navigateToPlatform"
        data-appid="{{item.appId}}"
        data-name="{{item.name}}">
        <image class="platform-icon" src="{{item.iconUrl}}" mode="aspectFill"></image>
        <text class="platform-name">{{item.name}}</text>
      </view>
    </view>
    
    <!-- 复制商家名称 -->
    <view class="copy-name">
      <button class="btn btn-small" bindtap="copyMerchantName">复制商家名称</button>
    </view>
  </view>

  <!-- 用户评分 -->
  <view class="rating-section card">
    <view class="section-title">我的评分</view>
    <view class="user-rating">
      <view class="rate-stars">
        <block wx:for="{{5}}" wx:key="*this">
          <image 
            class="rate-star-big {{item < userRating ? 'active' : ''}}" 
            src="/images/stars/{{item < userRating ? 'star-full.png' : 'star-empty.png'}}"
            bindtap="submitRating"
            data-rating="{{item + 1}}">
          </image>
        </block>
      </view>
      <text class="rating-tip">{{!isLogin ? '登录后才能评分' : (userRating > 0 ? '您的评分: ' + userRating + '星' : '点击星星进行评分')}}</text>
    </view>
  </view>

  <!-- 评论区 -->
  <view class="comment-section card">
    <view class="section-title">用户评论</view>
    
    <!-- 评论列表 -->
    <view class="comment-list">
      <block wx:if="{{!commentLoading && comments.length > 0}}">
        <view class="comment-item" wx:for="{{comments}}" wx:key="_id">
          <view class="comment-user">
            <image class="avatar" src="{{item.user.avatarUrl}}"></image>
            <text class="user-name">{{item.user.nickname}}</text>
          </view>
          <view class="comment-content">{{item.content}}</view>
          <view class="comment-footer">
            <text class="comment-time">{{item.timestamp ? item.timestamp.toLocaleDateString() : ''}}</text>
            <view class="like-btn {{item.isLiked ? 'active' : ''}} {{item.animating ? 'animate' : ''}}" bindtap="likeComment" data-id="{{item._id}}">
              <image src="/images/icons/{{item.isLiked ? 'like-filled.png' : 'like.png'}}"></image>
              <text>{{item.likes || 0}}</text>
              <view class="like-ripple" wx:if="{{!item.isLiked && item.animating}}"></view>
            </view>
          </view>
        </view>
      </block>
      
      <!-- 空状态 -->
      <view wx:if="{{!commentLoading && comments.length === 0}}" class="empty-state">
        <text>暂无评论，快来发表第一条评论吧</text>
      </view>
      
      <!-- 加载状态 -->
      <view wx:if="{{commentLoading}}" class="loading-state">
        <text>加载中...</text>
      </view>
    </view>
    
    <!-- 评论输入框 -->
    <view class="comment-input-area">
      <input 
        class="comment-input" 
        placeholder="{{isLogin ? '写下你的评论...' : '登录后才能评论'}}" 
        value="{{commentContent}}" 
        bindinput="inputComment"
        disabled="{{!isLogin}}"/>
      <button 
        class="btn btn-primary comment-submit-btn" 
        bindtap="submitComment"
        disabled="{{!isLogin || !commentContent}}">发表</button>
    </view>
  </view>
</view>

<!-- 加载状态 -->
<view wx:if="{{loading}}" class="loading-container">
  <text>加载中...</text>
</view> 